<div id="contentWrapper">

    <button type="button" onclick="showEditForm()">Neuen Kunden anlegen</button>
    <div class="divider"></div>
    {tableContent}
    <div class="divider"></div>
    <div class="flex spaceBetween">
        <div></div>
        <div>{totalCount}</div>
    </div>
</div>

<!-- Modal zur Löschabfrage -->
<div id="deleteModal" class="deleteModal"></div>

<!-- Formular zur Bearbeitung der Kundendaten -->
<div id="editFormWrapper" class="subFormWrapper hidden">
    <div id="toast">
        <p></p>
        <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
            <button id="confirmButton"></button>
            <button id="cancelButton" style="display: none">Abbrechen</button>
        </div>
    </div>
    <form id="newCostumerForm">
        <h2>Kunden bearbeiten</h2>

        <input type="hidden" name="id" value="">

        <label for="name">Kundenname</label>
        <input type="text" name="name" id="name" placeholder="Kundennamen eingeben" autocomplete="off" required>

        <label for="address">Kundenadresse</label>
        <textarea id="address" name="address" placeholder="Adresse eingeben" rows="6" cols="30" required></textarea>

        <label for="taxId">Steuernummer</label>
        <input type="text" id="taxId" name="taxId" placeholder="Die Steuernummer eingeben" autocomplete="off">

        <label for="salesTaxId">Umsatzsteuer-ID</label>
        <input type="text" id="salesTaxId" name="salesTaxId" placeholder="Die Umsatzsteuer-ID eingeben"
            autocomplete="off">
        <div class="marginTop">
            <button type="button" id="sendNewCostumer" onclick="createOrUpdate()">Speichern</button>
            <button type="button" id="cancelNewCostumer" onclick="hideEditForm()">Abbrechen</button>
        </div>
    </form>
</div>

<script>
    let resendData;

    function editCostumer(item) {

        let data;

        if (resendData && resendData.action == 'getCostumerDataToEdit') {

            data = resendData;

        } else {

            data = {
                id: $(item).closest('tr').find('td[id]').text(),
                action: 'getCostumerDataToEdit'
            };
        }

        let response = makeAjaxRequest(data);

        response
            .then(function (result) {

                result.data = JSON.parse(result.data);
                let costumer = result.data[0];
                $('form h2').text('Kunden bearbeiten');
                $('form input[name=id]').val(costumer.id)
                $('form #name').val(costumer.name);
                $('form #address').val(costumer.address);
                $('form #taxId').val(costumer.taxId);
                $('form #salesTaxId').val(costumer.salesTaxId);

                $('#editFormWrapper').removeClass('hidden');
                $('#deleteModal').css('display', 'none');
                resendData = '';

            })
            .catch(function (result) {
                resendData = data;
                let modalContent = `
                    <p>Da ist etwas schief gelaufen...</p>
                    <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                        <button id="confirmButton" onclick="editCostumer()">Erneut versuchen</button>
                        <button id="cancelButton" onclick="hideDeleteModal()">Abbrechen</button>
                    </div>
                    `;

                $('#deleteModal').css('display', 'flex').html(modalContent);

            });
    }


    function optInCostumerDeletion(item) {

        let id = $(item).closest('tr').find('td[id]').text();
        let modalContent = `
                 <p>Willst du den Kunden ${id} unwiderruflich löschen?</p>
                <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                    <button id="confirmButton" onclick="deleteCostumer(${id})">Löschen</button>
                    <button id="cancelButton" onclick="hideDeleteModal()">Abbrechen</button>
                </div>
            `;

        $('#deleteModal').css('display', 'flex').html(modalContent);
    }


    function deleteCostumer(id) {

        if (resendData && resendData.action == 'deleteCostumer') {

            data = resendData;

        } else {

            data = {
                action: 'deleteCostumer',
                id: id
            }
        }

        let response = makeAjaxRequest(data);

        response
            .then(function (result) {

                let modalContent = `
                        <p>Der Kunde ${id} wurde erfolgreich gelöscht.</p>
                        <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                            <button id="cancelButton" onclick="hideDeleteModal()">Okay</button>
                        </div>
                        `;

                $('#deleteModal').css('display', 'flex').html(modalContent);
                resendData = '';

            })
            .catch(function (result) {

                resendData = data;
                let modalContent = `
                    <p>Da ist etwas schief gelaufen...</p>
                    <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                        <button id="confirmButton" onclick="deleteCostumer()">Erneut versuchen</button>
                        <button id="cancelButton" onclick="hideDeleteModal()">Abbrechen</button>
                    </div>
                    `;

                $('#deleteModal').css('display', 'flex').html(modalContent);

            });
    }


    function createOrUpdate(event) {
        if (!$('form input[name=id]').val()) {
            createCostumer();
        } else {
            updateCostumer();
        }
    }


    function showEditForm() {
        $('form h2').text('Neuen Kunden anlegen');
        $('form input[name=id]').val('')
        $('form #name').val('');
        $('form #address').val('');
        $('form #taxId').val('');
        $('form #salesTaxId').val('');

        $('#editFormWrapper').removeClass('hidden');
    }


    function hideEditForm() {

        $('#editFormWrapper').addClass('hidden');
        resendData = '';
    }


    function hideDeleteModal() {

        $('#deleteModal').css('display', 'none');
        resendData = '';
    }
</script>