<div id="contentWrapper">

    <button type="button" onclick="showEditForm()">Neues Produkt anlegen</button>

    <div class="divider"></div>
    {tableContent}
    <div class="divider"></div>
    <div class="flex spaceBetween">
        <div></div>
        <div>{totalCount}</div>
    </div>

    <!-- Modal zur Löschabfrage -->
    <div id="deleteModal" class="deleteModal"></div>

    <div id="editFormWrapper" class="subFormWrapper hidden">
        <div id="toast">
            <p></p>
            <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                <button id="confirmButton"></button>
                <button id="cancelButton" style="display: none">Abbrechen</button>
            </div>
        </div>
        <form id="newProductForm">
            <h2>Produkt bearbeiten</h2>

            <input type="hidden" name="id">

            <label for="productTitle">Titel</label>
            <input type="text" id="productTitle" name="productTitle" placeholder="Eine Bezeichnung vergeben" required>

            <div class="marginTop"><label for="productPrice" style="display: inline">Netto-Preis</label><span
                    class="info" onclick="netPriceInfo()">?</span></div>
            <input type="text" id="productPrice" name="productPrice" placeholder="Format: 10.99" required>
            <button type="button" class="noMarginTop" onclick="netPriceCalculator()">berechnen</button>

            <div class="marginTop">
                <label>Mehrwertsteuer</label>
                <div>
                    <input type="radio" id="tax0" name="taxRate" value="0" required>
                    <label for="tax0" style="display: inline;">0 %</label>
                </div>
                <div>
                    <input type="radio" id="tax7" name="taxRate" value="7" required>
                    <label for="tax7" style="display: inline;">7 %</label>
                </div>
                <div>
                    <input type="radio" id="tax19" name="taxRate" value="19" required>
                    <label for="tax19" style="display: inline;">19 %</label>
                </div>
            </div>

            <label for="productDescription">Beschreibung (optional)</label>
            <textarea id="productDescription" name="productDescription"
                placeholder="Wichtige Infos zum Produkt..."></textarea>
            <div>
                <button type="button" id="sendNewProduct" onclick="createOrUpdate()">Speichern</button>
                <button type="button" id="cancelNewProduct" onclick="hideEditForm()">Abbrechen</button>
            </div>
        </form>
    </div>

    <script>
        let resendData;

        function editProduct(item) {

            let data;

            if (resendData && resendData.action == 'getProductDataToEdit') {

                data = resendData;

            } else {

                data = {
                    id: $(item).closest('tr').find('td[id]').text(),
                    action: 'getProductDataToEdit'
                };
            }

            let response = makeAjaxRequest(data);

            response
                .then(function (result) {

                    result.data = JSON.parse(result.data);
                    let product = result.data[0];
                    $('form input[name=id]').val(product.id)
                    $('form #productTitle').val(product.productTitle);
                    $('form #productPrice').val(product.productPrice);
                    $('form #productDescription').val(product.productDescription);

                    switch (product.taxRate) {
                        case 0:
                            $('form #tax0').prop('checked', true);
                            break;
                        case 7:
                            $('form #tax7').prop('checked', true);
                            break;
                        case 19:
                            $('form #tax19').prop('checked', true);
                            break;
                    }

                    $('#editFormWrapper').removeClass('hidden');
                    $('#deleteModal').css('display', 'none');
                    resendData = '';

                })
                .catch(function (result) {
                    resendData = data;
                    let modalContent = `
                    <p>Da ist etwas schief gelaufen...</p>
                    <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                        <button id="confirmButton" onclick="editProduct()">Erneut versuchen</button>
                        <button id="cancelButton" onclick="hideDeleteModal()">Abbrechen</button>
                    </div>
                    `;

                    $('#deleteModal').css('display', 'flex').html(modalContent);

                });
        }


        function optInProductDeletion(item) {

            let id = $(item).closest('tr').find('td[id]').text();
            let modalContent = `
                 <p>Willst du das Produkt ${id} unwiderruflich löschen?</p>
                <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                    <button id="confirmButton" onclick="deleteProduct(${id})">Löschen</button>
                    <button id="cancelButton" onclick="hideDeleteModal()">Abbrechen</button>
                </div>
            `;

            $('#deleteModal').css('display', 'flex').html(modalContent);
        }


        function deleteProduct(id) {

            if (resendData && resendData.action == 'deleteProduct') {

                data = resendData;

            } else {

                data = {
                    action: 'deleteProduct',
                    id: id
                }
            }

            let response = makeAjaxRequest(data);

            response
                .then(function (result) {

                    let modalContent = `
                        <p>Das Produkt ${id} wurde erfolgreich gelöscht.</p>
                        <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                            <button id="cancelButton" onclick="hideDeleteModal()">Okay</button>
                        </div>
                        `;

                    $('#deleteModal').css('display', 'flex').html(modalContent);
                    resendData = '';

                })
                .catch(function (result) {

                    resendData = data;
                    let modalContent = `
                    <p>Da ist etwas schief gelaufen...</p>
                    <div id="toastButtonWrapper" style="display: flex; gap: 1em;">
                        <button id="confirmButton" onclick="deleteProduct()">Erneut versuchen</button>
                        <button id="cancelButton" onclick="hideDeleteModal()">Abbrechen</button>
                    </div>
                    `;

                    $('#deleteModal').css('display', 'flex').html(modalContent);

                });
        }


        function createOrUpdate(event) {
            if (!$('form input[name=id]').val()) {
                createProduct();
            } else {
                updateProduct();
            }
        }

        function showEditForm() {
            $('form h2').text('Neues Produkt anlegen');
            $('form input[name=id]').val('')
            $('form #productTitle').val('');
            $('form #productPrice').val('');
            $('form #productDescription').val('');
            $('form #tax0').prop('checked', false);
            $('form #tax7').prop('checked', false);
            $('form #tax19').prop('checked', false);


            $('#editFormWrapper').removeClass('hidden');
        }

        function hideEditForm() {

            $('#editFormWrapper').addClass('hidden');
            resendData = '';
        }


        function hideDeleteModal() {

            $('#deleteModal').css('display', 'none');
            resendData = '';
        }
    </script>